<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Cube Timer - Cubically AI Edition</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Cubing.js for 3D scramble visualization - Using the recommended twisty player module -->
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="style.css">
</head>

<body class="theme-dark"> <!-- Set default theme class here -->
    <div class="container mx-auto rounded-3xl">
        <!-- Authentication Controls - Positioned at the top right, uses flex for responsiveness -->
        <div class="flex flex-wrap justify-end gap-2 text-sm auth-corner-buttons">
            <button id="signInBtn" class="button-primary">Sign In</button>
            <button id="signUpBtn" class="button-secondary">Sign Up</button>
            <button id="signOutBtn" class="button-secondary" style="display:none;">Sign Out</button>
        </div>

        <h1 class="text-4xl font-bold text-center text-gradient mb-6">Rubik's Cube Timer <span
                class="text-2xl block sm:inline-block">Cubically AI Edition</span></h1>

        <!-- User Info Display -->
        <div class="text-center text-gray-400 mb-4">
            <span id="userEmailDisplay">Welcome, Guest</span>
        </div>

        <!-- Main Timer Section -->
        <div class="timer-section">
            <div id="timerDisplay" class="timer-display">00:00.000</div>
            <div id="scrambleDisplay" class="scramble-display">Generating Scramble...</div>
            <!-- 3D Cube Viewer (initially hidden by default, controlled by settings) -->
            <twisty-player id="scramble3DViewer"
                class="w-full h-64 sm:h-80 md:h-96 lg:h-120 mx-auto rounded-lg shadow-lg mb-4"
                style="display: none; background: var(--card-bg);"></twisty-player>
        </div>

        <!-- Global Penalty Buttons (NEW: Added IDs and static placement) -->
        <div id="penaltyButtons" class="flex justify-center space-x-4 mb-4" style="display: none;">
            <button id="plus2Btn" class="button-secondary">+2 Penalty</button>
            <button id="dnfBtn" class="button-secondary">DNF</button>
            <button id="resetPenaltyBtn" class="button-secondary">Clear Penalty</button>
        </div>


        <!-- Action Buttons -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="openSettingsModal" class="button-primary">Settings</button>
            <button id="openChatBtn" class="button-primary">Chat with Jarvis</button>
            <button id="voiceCommandBtn" class="button-primary">Voice Command <i class="fas fa-microphone ml-2"></i></button>
        </div>

        <!-- Voice Feedback Display (NEW) -->
        <div id="voiceFeedbackDisplay" class="voice-feedback-display" style="display: none;">
            <span id="voiceListeningText" class="voice-text"></span>
            <div id="voiceListeningIndicator" class="voice-indicator">
                <span>.</span><span>.</span><span>.</span>
            </div>
            <div id="voiceLiveTranscript" class="voice-live-transcript"></div>
        </div>

        <!-- Statistics Section -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Best Time</span>
                <span id="bestTimeDisplay" class="stat-value">--:--.--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Ao5</span>
                <span id="ao5Display" class="stat-value">--:--.--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Ao12</span>
                <span id="ao12Display" class="stat-value">--:--.--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Solves</span>
                <span id="solveCountDisplay" class="stat-value">0</span>
            </div>
        </div>

        <!-- Solve History Section -->
        <div id="solveHistoryContainer" class="solve-history-container">
            <h2 class="text-2xl font-bold text-gradient mb-4 text-center">Solve History</h2>
            <p id="noSolvesMessage" class="text-gray-400 text-center mb-4">No solves recorded yet. Start cubing!</p>
            <ul id="solveHistoryList" class="solve-history-list">
                <!-- Solve items will be dynamically added here -->
            </ul>
        </div>

    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
        <div class="modal-content">
            <button class="modal-close-button" id="closeAuthModal" aria-label="Close authentication form">&times;</button>
            <h2 id="authModalTitle" class="text-2xl font-bold text-gradient mb-4 text-center">Sign In</h2>
            <div class="mb-4">
                <label for="email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="email"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200"
                    placeholder="your.email@example.com">
            </div>
            <div id="usernameFieldGroup" class="mb-4" style="display:none;">
                <label for="usernameInput" class="block text-gray-300 text-sm font-bold mb-2">Username:</label>
                <input type="text" id="usernameInput"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200"
                    placeholder="Choose a username">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                <input type="password" id="password"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-200"
                    placeholder="********">
            </div>
            <div id="authError" class="text-red-500 text-xs italic mb-4" style="display:none;"></div>
            <div class="flex items-center justify-between flex-wrap gap-3">
                <button id="emailAuthBtn" class="button-primary w-full sm:w-auto">Sign In</button>
                <button id="googleSignInBtn" class="button-secondary w-full sm:w-auto">Sign In with Google</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
        <div class="modal-content">
            <button class="modal-close-button" id="closeSettingsModal" aria-label="Close settings">&times;</button>
            <h2 class="text-2xl font-bold text-gradient mb-4 text-center">Settings</h2>

            <div class="mb-4">
                <label for="themeSelect" class="block text-gray-300 text-sm font-bold mb-2">Theme:</label>
                <select id="themeSelect"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="vibrant">Vibrant</option>
                </select>
            </div>

            <div class="mb-4 flex items-center justify-between">
                <label for="enableSoundEffectsToggle" class="text-gray-300 text-sm font-bold">Enable Sound Effects:</label>
                <input type="checkbox" id="enableSoundEffectsToggle" class="toggle-switch">
            </div>

            <div class="mb-4 flex items-center justify-between">
                <label for="enableInspectionToggle" class="text-gray-300 text-sm font-bold">Enable 15s Inspection:</label>
                <input type="checkbox" id="enableInspectionToggle" class="toggle-switch">
            </div>

            <div class="mb-4">
                <label for="cubeTypeSelect" class="block text-gray-300 text-sm font-bold mb-2">Default Cube Type:</label>
                <select id="cubeTypeSelect"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200">
                    <option value="3x3">3x3</option>
                    <option value="2x2">2x2</option>
                    <option value="4x4">4x4</option>
                    <option value="pyraminx">Pyraminx</option>
                </select>
            </div>

            <div class="mb-4 flex items-center justify-between">
                <label for="show3DCubeViewToggle" class="text-gray-300 text-sm font-bold">Show 3D Cube Scramble:</label>
                <input type="checkbox" id="show3DCubeViewToggle" class="toggle-switch">
            </div>

            <div class="mb-6">
                <label for="wakeWordInput" class="block text-gray-300 text-sm font-bold mb-2">Voice AI Wake Word:</label>
                <input type="text" id="wakeWordInput"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200"
                    placeholder="e.g., Jarvis">
            </div>

            <button id="saveSettingsBtn" class="button-primary w-full">Save Settings</button>
        </div>
    </div>

    <!-- AI Insight Modal -->
    <div id="aiInsightModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
        <div class="modal-content">
            <button class="modal-close-button" id="closeAiInsightModal" aria-label="Close AI insight">&times;</button>
            <h2 class="text-2xl font-bold text-gradient mb-4">Solve Insight ✨</h2>
            <div id="aiInsightContent" class="text-gray-300 text-sm sm:text-base">
                <div class="spinner mx-auto my-4" style="display: none;"></div>
                <p id="insightMessage" class="text-center">Generating insight...</p>
                <div id="optimalSolutionDisplay" class="mt-4 p-3 bg-gray-700 rounded-lg" style="display: none;">
                    <h3 class="text-lg font-semibold text-gradient mb-2">Optimal Solution:</h3>
                    <p id="optimalSolutionText" class="font-mono text-white text-sm"></p>
                </div>
                <div id="personalizedTipDisplay" class="mt-4 p-3 bg-gray-700 rounded-lg" style="display: none;">
                    <h3 class="text-lg font-semibold text-gradient mb-2">Personalized Tip:</h3>
                    <p id="personalizedTipText" class="text-white text-sm"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal (NEW) -->
    <div id="chatModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
        <div class="modal-content flex flex-col h-full max-h-[80vh]">
            <button class="modal-close-button" id="closeChatModal" aria-label="Close chat">&times;</button>
            <h2 class="text-2xl font-bold text-gradient mb-4 text-center">Chat with Jarvis</h2>
            <div id="chatHistory" class="flex-grow overflow-y-auto p-3 bg-gray-800 rounded-lg mb-4 text-gray-200 text-sm">
                <!-- Chat messages will be dynamically added here -->
                <div class="chat-message jarvis-message">
                    <span class="font-bold text-indigo-400">Jarvis: </span>Greetings, Sir Sevindu. How may I assist you?
                </div>
            </div>
            <div class="flex">
                <input type="text" id="chatInput" placeholder="Ask Jarvis a question or give a command..."
                    class="flex-grow shadow appearance-none border rounded-l-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200">
                <button id="chatSendBtn" class="button-primary rounded-l-none">Send</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Link to external JavaScript file -->
    <script src="script.js" type="module"></script>
</body>

</html>
