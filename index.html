<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Cube Timer - Cubically AI Edition</title>
    <!-- Tailwind CSS CDN - Note: For production, consider installing Tailwind as a PostCSS plugin or using the Tailwind CLI for optimized builds. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Cubing.js for 3D scramble visualization - Using the recommended twisty player module -->
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="theme-dark"> <!-- Set default theme class here -->
    <div class="container mx-auto rounded-3xl">
        <!-- Authentication Controls - Positioned at the top right, uses flex for responsiveness -->
        <div class="flex flex-wrap justify-end gap-2 text-sm auth-corner-buttons">
            <button id="signInBtn" class="button-primary">Sign In</button>
            <button id="signUpBtn" class="button-secondary">Sign Up</button>
            <button id="signOutBtn" class="button-primary" style="display: none;">Sign Out</button>
            <span id="usernameDisplay" class="text-sm font-semibold text-gray-300 flex items-center px-2">Current User: Guest</span>
        </div>

        <h1 class="text-4xl font-bold text-center mb-6">Rubik's Cube Timer</h1>

        <!-- Main Timer and Scramble Section -->
        <div class="main-content">
            <div class="scramble-display-container">
                <p id="scrambleTextDisplay" class="scramble-display"></p>
                <div id="cube3DContainer" class="cube-3d-container" style="display: none;">
                    <twisty-player id="scramble3DViewer" background="#0f172a" control-panel="none" style="width: 100%; height: 100%;"></twisty-player>
                    <div class="twisty-player-controls">
                        <button id="playPreviewBtn" class="button-secondary"><i class="fas fa-play"></i></button>
                        <button id="pausePreviewBtn" class="button-secondary"><i class="fas fa-pause"></i></button>
                        <button id="restartPreviewBtn" class="button-secondary"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
            </div>

            <div id="timerDisplay" class="timer-display">00:00.000</div>

            <div class="button-group">
                <button id="startStopBtn" class="button-primary">Start / Stop (Space)</button>
                <button id="resetBtn" class="button-secondary">Reset</button>
                <button id="scrambleBtn" class="button-secondary">New Scramble</button>
                <!-- NEW: Lessons Button added back to main layout -->
                <button id="openLessonsBtn" class="button-secondary">Lessons</button>
                <button id="settingsBtn" class="button-secondary">Settings</button>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Best Time</div>
                <div id="bestTime" class="value">--:--.--</div>
            </div>
            <div class="stat-card">
                <div class="label">Average of 5</div>
                <div id="ao5" class="value">--:--.--</div>
            </div>
            <div class="stat-card">
                <div class="label">Average of 12</div>
                <div id="ao12" class="value">--:--.--</div>
            </div>
            <div class="stat-card">
                <div class="label">Solves</div>
                <div id="solveCount" class="value">0</div>
            </div>
        </div>

        <!-- Solve History Section -->
        <div class="solve-history-section">
            <h2 class="text-2xl font-bold mb-4 text-center">Solve History</h2>
            <p id="noSolvesMessage" class="text-center text-gray-400 italic" style="display: none;">No solves recorded yet. Start solving!</p>
            <div id="solveHistoryList" class="solve-history-list">
                <!-- Solve items will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Settings</h2>
            <button id="closeSettingsModal" class="close-button">&times;</button>

            <div class="setting-item">
                <label for="inspectionToggle" class="setting-label">Enable Inspection (15s)</label>
                <label class="switch">
                    <input type="checkbox" id="inspectionToggle">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="setting-item">
                <label for="soundEffectsToggle" class="setting-label">Enable Sound Effects</label>
                <label class="switch">
                    <input type="checkbox" id="soundEffectsToggle">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="setting-item">
                <label for="cubeTypeSelect" class="setting-label">Cube Type</label>
                <select id="cubeTypeSelect" class="select-box">
                    <option value="3x3">3x3</option>
                    <option value="2x2">2x2</option>
                    <option value="4x4">4x4</option>
                    <option value="pyraminx">Pyraminx</option>
                </select>
            </div>

            <div class="setting-item">
                <label for="themeSelect" class="setting-label">Theme</label>
                <select id="themeSelect" class="select-box">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="vibrant">Vibrant</option>
                </select>
            </div>

            <div class="setting-item">
                <label for="cubeViewToggle" class="setting-label">Show 3D Cube View</label>
                <label class="switch">
                    <input type="checkbox" id="cubeViewToggle">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="setting-item">
                <label for="settingsUsernameInput" class="setting-label">Username</label>
                <input type="text" id="settingsUsernameInput" class="text-input" placeholder="Enter your username">
                <button id="saveUsernameBtn" class="button-primary mt-2">Save Username</button>
                <p id="usernameUpdateMessage" class="text-sm mt-2" style="display: none;"></p>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 id="authModalTitle" class="text-2xl font-bold mb-4">Sign In / Sign Up</h2>
            <button id="closeAuthModal" class="close-button">&times;</button>

            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-300">Email</label>
                <input type="email" id="email" class="text-input" placeholder="your.email@example.com">
            </div>
            <div id="usernameFieldGroup" class="mb-4" style="display: none;">
                <label for="usernameInput" class="block text-sm font-medium text-gray-300">Username</label>
                <input type="text" id="usernameInput" class="text-input" placeholder="Choose a username">
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                <input type="password" id="password" class="text-input" placeholder="Your password">
            </div>

            <p id="authError" class="text-red-500 text-sm mb-4" style="display: none;"></p>

            <button id="emailAuthBtn" class="button-primary w-full mb-3">Sign In</button>
            <div class="text-center text-gray-400 mb-3">- OR -</div>
            <button id="googleSignInBtn" class="button-secondary w-full flex items-center justify-center">
                <i class="fab fa-google mr-2"></i> Sign In with Google
            </button>
        </div>
    </div>

    <!-- AI Insight Modal -->
    <div id="aiInsightModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">AI Solve Insight</h2>
            <button id="closeAiInsightModal" class="close-button">&times;</button>

            <div id="aiInsightContent" class="text-gray-300">
                <p id="insightMessage" class="mb-2"></p>
                <div class="spinner" style="display: none;"></div>

                <div id="scrambleAnalysisDisplay" class="insight-section" style="display: none;">
                    <h3 class="text-xl font-semibold mb-1">Scramble Analysis</h3>
                    <p id="scrambleAnalysisText"></p>
                </div>

                <div id="personalizedTipDisplay" class="insight-section" style="display: none;">
                    <h3 class="text-xl font-semibold mb-1">Personalized Tip</h3>
                    <p id="personalizedTipText"></p>
                </div>

                <div id="targetedPracticeFocusDisplay" class="insight-section" style="display: none;">
                    <h3 class="text-xl font-semibold mb-1">Targeted Practice Focus</h3>
                    <p id="targetedPracticeFocusText"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lessons Modal (NEW) -->
    <div id="lessonsModal" class="modal">
        <div class="modal-content !max-w-3xl">
            <h2 id="lessonModalTitle" class="text-2xl font-bold mb-4">Cubing Lessons</h2>
            <button id="closeLessonsModalBtn" class="close-button">&times;</button>

            <!-- Lesson Topic Selection / Input -->
            <div id="lessonTopicSelection" class="mb-4">
                <p class="mb-2 text-gray-300">What cubing topic would you like to learn about, Sir Sevindu?</p>
                <input type="text" id="lessonTopicInput" class="text-input w-full" placeholder="e.g., F2L, OLL, Beginner Method, Pyraminx basics">
                <button id="generateLessonBtn" class="button-primary mt-3 w-full">Generate Lesson</button>
                <p id="lessonGenerationError" class="text-red-500 text-sm mt-2" style="display: none;"></p>
            </div>

            <!-- Lesson Content Display -->
            <div id="lessonContentDisplay" style="display: none;">
                <h3 id="lessonTitleDisplay" class="text-xl font-semibold mb-2"></h3>
                <p id="lessonDescriptionDisplay" class="text-gray-300 mb-4"></p>

                <div id="lessonStepsContainer" class="lesson-steps-container">
                    <!-- Lesson steps will be dynamically loaded here -->
                    <div class="lesson-step-card">
                        <h4 id="lessonStepTitleDisplay" class="text-lg font-semibold mb-2"></h4>
                        <p id="lessonStepDescriptionDisplay" class="text-gray-300 mb-2"></p>
                        <div id="lessonVisualContainer" class="twisty-player-lesson-container" style="display: none;">
                            <!-- twisty-player will be inserted here dynamically -->
                        </div>
                        <p id="lessonExplanationDisplay" class="text-sm text-gray-400 italic mt-2"></p>
                    </div>
                </div>

                <div class="lesson-navigation mt-6 flex justify-between items-center">
                    <button id="prevLessonStepBtn" class="button-secondary" disabled><i class="fas fa-chevron-left mr-2"></i> Previous</button>
                    <span id="lessonStepCounter" class="text-gray-400 text-sm">Step 1 of 1</span>
                    <button id="nextLessonStepBtn" class="button-primary">Next <i class="fas fa-chevron-right ml-2"></i></button>
                </div>
            </div>

            <div id="lessonLoadingSpinner" class="spinner" style="display: none;"></div>
        </div>
    </div>


    <!-- Jarvis Orb Voice Feedback Display (moved to bottom center) -->
    <div id="voiceFeedbackDisplay" class="voice-feedback-display">
        <p id="voiceListeningText">Listening for 'Jarvis'...</p>
        <p id="voiceLiveTranscript" class="text-xs text-gray-400 italic mt-1" style="display: none;"></p>
        <div id="voiceListeningIndicator" class="listening-indicator">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <!-- Voice Command Button (fixed position) -->
    <button id="voiceCommandBtn" class="fixed bottom-4 right-4 md:bottom-4 md:right-4 z-50 button-primary !rounded-full !w-14 !h-14 !p-0 flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-200">
        <i class="fas fa-microphone text-2xl"></i>
    </button>

    <!-- Chat Button (fixed position, mirroring voice button) -->
    <button id="openChatBtn" class="fixed bottom-4 left-4 md:bottom-4 md:left-4 z-50 button-primary !rounded-full !w-14 !h-14 !p-0 flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-200">
        <i class="fas fa-comment-dots text-2xl"></i>
    </button>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal chat-modal">
        <div class="modal-content chat-modal-content">
            <h2 class="text-2xl font-bold mb-4">Jarvis Chat</h2>
            <button id="closeChatModal" class="close-button">&times;</button>

            <div id="chatHistory" class="chat-history">
                <!-- Chat messages will be dynamically added here -->
                <div class="chat-message jarvis-message">
                    <span class="font-bold text-indigo-400">Jarvis: </span>At your service, Sir Sevindu. How may I assist you via text?
                </div>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" class="text-input chat-text-input" placeholder="Type your command or question...">
                <button id="chatSendBtn" class="button-primary chat-send-button">Send</button>
            </div>
        </div>
    </div>


    <script src="script.js" type="module"></script>
</body>

</html>
